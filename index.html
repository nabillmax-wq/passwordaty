<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Passwordaty â€“ Ø®Ø²Ù†ØªÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- CryptoJS for AES encryption -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.js"></script>
  
  <style>
    :root { --pri:#0a7; --pri2:#068; --bg:#f6f7f9; --card:#fff; --danger:#c0392b; }
    * { box-sizing: border-box; }
    body { font-family: Tahoma, Arial, sans-serif; direction: rtl; background: var(--bg ); margin: 0; padding: 24px; color: #222; }
    h1 { margin-top: 0; text-align: center; }
    section { max-width: 900px; margin: 16px auto; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, select, textarea, button { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit; font-size: 1rem; }
    textarea { min-height: 90px; resize: vertical; }
    button { background: var(--pri); color: #fff; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background: var(--pri2); }
    button.secondary { background: #777; }
    button.danger { background: var(--danger); }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    ul#itemsList { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
    .item { background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 10px; }
    .item .meta { font-size: .85rem; color: #666; word-wrap: break-word; }
    .item code { background: #eee; padding: 2px 5px; border-radius: 4px; font-family: monospace; cursor: pointer; }
    .hint { color: #666; font-size: .9rem; }
    @media(max-width: 800px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>Ø®Ø²Ù†Ø© Passwordaty</h1>

  <!-- Auth -->
  <section id="auth-section">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <div class="row">
      <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
      <button id="signupBtn" class="secondary">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
  </section>

  <!-- Master password -->
  <section id="master-section" style="display:none;">
    <h2>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
    <p class="hint">Ù„Ù† ØªÙØ±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ±ØŒ ØªÙØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù„Ù„ØªØ´ÙÙŠØ± ÙˆÙÙƒÙ‘Ù‡ Ù…Ø­Ù„ÙŠÙ‹Ø§.</p>
    <input type="password" id="master" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" />
    <button id="setMasterBtn">Ù…ØªØ§Ø¨Ø¹Ø©</button>
  </section>

  <!-- Dashboard -->
  <section id="dashboard" style="display:none;">
    <div class="topbar">
      <strong id="whoami"></strong>
      <div class="row">
        <select id="filterCategory">
          <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
          <option>Ø¨Ù†ÙˆÙƒ</option>
          <option>ØªØ·Ø¨ÙŠÙ‚Ø§Øª</option>
          <option>Ù…ÙˆØ§Ù‚Ø¹</option>
          <option>Ø¨Ø·Ø§Ù‚Ø§Øª</option>
          <option>Ø£Ø®Ø±Ù‰</option>
        </select>
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ±â€¦" />
        <button id="logoutBtn" class="danger">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</h3>
        <input id="itemTitle" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù…Ø«Ù„Ø§Ù‹: Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ)" />
        <input id="itemUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Ø§Ù„Ø¨Ø±ÙŠØ¯" />
        <input id="itemPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        <textarea id="itemNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        <select id="itemCat">
          <option>Ø¨Ù†ÙˆÙƒ</option>
          <option>ØªØ·Ø¨ÙŠÙ‚Ø§Øª</option>
          <option>Ù…ÙˆØ§Ù‚Ø¹</option>
          <option>Ø¨Ø·Ø§Ù‚Ø§Øª</option>
          <option>Ø£Ø®Ø±Ù‰</option>
        </select>
        <button id="addItemBtn">Ø­ÙØ¸</button>
      </div>

      <div class="card">
        <h3>Ø¹Ù†Ø§ØµØ±ÙŠ</h3>
        <ul id="itemsList"></ul>
      </div>
    </div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, query, orderBy, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù…Ø´Ø±ÙˆØ¹Ùƒ (ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ) ===
    const firebaseConfig = {
      apiKey: "AIzaSyApEV7dse7szZtKoo3M7u8lexD4qcivM5c",
      authDomain: "nabillmax-1ec98.firebaseapp.com",
      projectId: "nabillmax-1ec98",
      storageBucket: "nabillmax-1ec98.appspot.com", // Corrected value
      messagingSenderId: "1088959582431",
      appId: "1:1088959582431:web:7814b350b02175789c196a",
      measurementId: "G-D164EXZHFY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM elements
    const authSection = document.getElementById("auth-section");
    const masterSection = document.getElementById("master-section");
    const dashboard = document.getElementById("dashboard");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const setMasterBtn = document.getElementById("setMasterBtn");
    const whoami = document.getElementById("whoami");
    const itemsList = document.getElementById("itemsList");
    const addItemBtn = document.getElementById("addItemBtn");
    const filterCategory = document.getElementById("filterCategory");
    const searchInput = document.getElementById("search");

    let MASTER = null;
    let itemsUnsub = null;

    // Crypto helpers using CryptoJS
    function encryptObject(obj, pass) {
      const json = JSON.stringify(obj);
      return CryptoJS.AES.encrypt(json, pass).toString();
    }
    function decryptObject(cipherText, pass) {
      const bytes = CryptoJS.AES.decrypt(cipherText, pass);
      const text = bytes.toString(CryptoJS.enc.Utf8);
      if (!text) throw new Error("ÙØ´Ù„ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±: ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø±Ø¦ÙŠØ³ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      return JSON.parse(text);
    }

    // Auth
    signupBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ… â€” Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.");
      } catch (e) { alert(e.message); }
    });

    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) { alert(e.message); }
    });

    logoutBtn.addEventListener("click", async () => {
      if (itemsUnsub) itemsUnsub();
      MASTER = null;
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        whoami.textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ ${user.email}`;
        authSection.style.display = "none";
        masterSection.style.display = "block";
        dashboard.style.display = "none";
        document.getElementById("master").value = "";
        document.getElementById("master").focus();
      } else {
        whoami.textContent = "";
        authSection.style.display = "block";
        masterSection.style.display = "none";
        dashboard.style.display = "none";
      }
    });

    setMasterBtn.addEventListener("click", () => {
      const m = document.getElementById("master").value;
      if (!m || m.length < 6) return alert("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 6 Ø£Ø­Ø±Ù.");
      MASTER = m;
      masterSection.style.display = "none";
      dashboard.style.display = "block";
      startLiveQuery();
    });

    addItemBtn.addEventListener("click", async () => {
      try {
        if (!MASTER) return alert("Ø¹ÙŠÙ‘Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.");
        const item = {
          title: document.getElementById("itemTitle").value.trim(),
          username: document.getElementById("itemUser").value.trim(),
          password: document.getElementById("itemPass").value,
          note: document.getElementById("itemNote").value.trim(),
          category: document.getElementById("itemCat").value,
          createdAt: Date.now()
        };
        if (!item.title) return alert("Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø·Ù„ÙˆØ¨.");
        const cipher = encryptObject(item, MASTER);
        const col = collection(db, "vault", auth.currentUser.uid, "items");
        await addDoc(col, { cipher, ts: Date.now(), category: item.category });
        ["itemTitle","itemUser","itemPass","itemNote"].forEach(id => document.getElementById(id).value = "");
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø´ÙÙ‘Ø±Ù‹Ø§ ğŸ”’");
      } catch (e) { alert(e.message); }
    });

    function startLiveQuery() {
      if (itemsUnsub) itemsUnsub();
      const col = collection(db, "vault", auth.currentUser.uid, "items");
      const q = query(col, orderBy("ts", "desc"));
      
      let snapCache; // To hold the latest data snapshot

      const renderItems = () => {
        if (!snapCache) return;
        const filter = filterCategory.value || "";
        const qtext = searchInput.value.trim().toLowerCase();
        itemsList.innerHTML = "";
        snapCache.forEach(doc => {
          try {
            const data = decryptObject(doc.data().cipher, MASTER);
            if (filter && data.category !== filter) return;
            const hay = (data.title + " " + data.username + " " + (data.note||"")).toLowerCase();
            if (qtext && !hay.includes(qtext)) return;
            const li = document.createElement("li");
            li.className = "item";
            li.innerHTML = `
              <div><strong>${escapeHTML(data.title)}</strong> <span class="meta">[${data.category}]</span></div>
              <div class="meta">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${escapeHTML(data.username)}</div>
              <div class="meta">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: <code title="Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®">${escapeHTML(data.password)}</code></div>
              ${data.note ? `<div class="meta">Ù…Ù„Ø§Ø­Ø¸Ø©: ${escapeHTML(data.note)}</div>` : ""}
            `;
            itemsList.appendChild(li);
          } catch(err){
            const li = document.createElement("li");
            li.className = "item";
            li.innerHTML = `<div class="meta">Ø¹Ù†ØµØ± ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© (ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©).</div>`;
            itemsList.appendChild(li);
          }
        });
      };

      itemsUnsub = onSnapshot(q, (snap) => {
        snapCache = snap;
        renderItems();
      });

      [filterCategory, searchInput].forEach(el => el.addEventListener("input", renderItems));
    }
    
    // Event delegation for copying password
    itemsList.addEventListener('click', function(e) {
      if (e.target && e.target.nodeName === 'CODE') {
        const textToCopy = e.target.textContent;
        navigator.clipboard.writeText(textToCopy).then(() => {
          alert('ØªÙ… Ù†Ø³Ø® ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!');
        }).catch(err => {
          console.error('Failed to copy: ', err);
        });
      }
    });

    function escapeHTML(s){ return s.replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#039;" }[m])); }
  </script>
</body>
</html>
